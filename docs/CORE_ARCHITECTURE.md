# Архитектура ядра системы Graph Analyser

## Обзор

Реализовано модульное, масштабируемое и безопасное ядро для управления научными статьями и графами связей.

## Структура системы

### 1. Основные модули (src/core/)

#### Logger.ts - Система логирования
- Уровни логирования: DEBUG, INFO, WARN, ERROR, FATAL
- Контекстное логирование с привязкой к пользователям и сессиям
- Подписка на события логирования
- Фильтрация логов по уровню, модулю, времени
- Модульная архитектура с поддержкой подписчиков

#### ErrorHandler.ts - Обработка ошибок
- Типизация ошибок: VALIDATION, AUTHENTICATION, AUTHORIZATION, NOT_FOUND, CONFLICT, INTERNAL, EXTERNAL_API, DATABASE, NETWORK, RATE_LIMIT
- Кастомные классы ошибок с правильными HTTP статусами
- Сбор метрик ошибок (типизация, кодирование, хронология)
- Форматирование ответов для API
- Трекинг последних ошибок (до 100)

#### SessionManager.ts - Управление сессиями
- Создание и валидация сессий пользователей
- Обновление токенов (access + refresh)
- Автоматическая очистка просроченных сессий
- Проверка прав доступа (permissions)
- Ограничение количества сессий на пользователя
- Метрики активности сессий

#### Database.ts - База данных (SQLite)
- CRUD операции для статей, связей (edges), паттернов, пользователей
- Реляционная модель с внешними ключами
- Индексация для оптимизации запросов
- WAL (Write-Ahead Logging) для производительности
- Метрики базы данных
- Аудит действий

### 2. Веб-интерфейс администратора (src/pages/AdminPage.tsx)

#### Вкладки интерфейса:
- **Обзор** - метрики системы в реальном времени
- **Сессии** - детализация активных сессий по пользователям
- **База данных** - статистика хранимых данных
- **Логи** - просмотр и фильтрация системных логов
- **Ошибки** - анализ ошибок по типам и кодам

#### Функции:
- Автообновление метрик каждые 5 секунд
- Очистка логов и ошибок
- Раскрытие деталей записей логов
- Визуализация статистики

### 3. Консоль управления (cli/index.ts)

#### Доступные команды:
```
help           - Показать список команд
status         - Показать статус системы
metrics        - Показать метрики системы
logs [level] [module] [count] - Показать логи
errors         - Показать ошибки
sessions       - Показать активные сессии
db:stats       - Показать статистику базы данных
db:init        - Инициализировать базу данных
clear          - Очистить экран
exit/quit      - Выйти из консоли
```

### 4. API маршруты (api/routes/admin.ts)

#### Эндпоинты:
- `GET /api/admin/metrics` - получить все метрики
- `DELETE /api/admin/logs` - очистить логи
- `DELETE /api/admin/errors` - очистить ошибки

## Безопасность

### Аутентификация и авторизация
- JWT-подобные токены (access + refresh)
- Проверка прав доступа на уровне SessionManager
- Администраторы имеют все права по умолчанию
- Отслеживание активности сессий

### Защита данных
- Параметризованные запросы к БД (защита от SQL-injection)
- Валидация входных данных
- Логирование всех критических операций
- Аудит действий пользователей

## Масштабируемость

### Горизонтальное масштабирование
- Stateless сессии (хранятся в памяти, легко мигрируются в Redis)
- Модульная архитектура - можно разнести компоненты по разным сервисам

### Вертикальное масштабирование
- Индексы базы данных для быстрых запросов
- WAL режим для параллельных операций
- Пул соединений (может быть добавлен)

### Производительность
- Асинхронные операции везде, где возможно
- Пакетная обработка данных
- Кэширование метрик
- Очистка устаревших данных

## Тестирование

### Unit-тесты (src/core/*.test.ts)
- Logger.test.ts - тестирование системы логирования
- ErrorHandler.test.ts - тестирование обработки ошибок
- SessionManager.test.ts - тестирование управления сессиями

### Интеграционные тесты (src/core/integration.test.ts)
- Database + Session Manager интеграция
- Database + Logger интеграция
- Logger + ErrorHandler интеграция
- Полные рабочие процессы
- Тесты производительности
- Проверка целостности данных

## Метрики и мониторинг

### Системные метрики
- Активные сессии
- Уникальные пользователи
- Количество записей в БД (статьи, связи, паттерны, пользователи)
- Общее количество ошибок
- Распределение ошибок по типам и кодам

### Метрики производительности
- Время ответа API
- Время выполнения операций БД
- Количество запросов в секунду

## Запуск системы

### 1. Установка зависимостей
```bash
npm install
```

### 2. Запуск в режиме разработки
```bash
npm run dev
```

### 3. Запуск консоли управления
```bash
npm run cli
```

### 4. Запуск тестов
```bash
npm test                    # Все тесты
npm run test:ui            # UI для тестов
npm run test:coverage      # Покрытие кода
```

### 5. Сборка для продакшена
```bash
npm run build
npm run preview
```

## Интеграция с существующим кодом

### Backend (api/server.ts)
- Инициализация базы данных при запуске
- Глобальный обработчик ошибок
- Логирование всех запросов
- Подключение админских маршрутов

### Frontend (src/App.tsx)
- Маршрут `/admin` для панели администратора
- Встраивание в существующую навигацию

## Следующие шаги для улучшения

1. **Постоянное хранение сессий** - миграция в Redis
2. **Аутентификация пользователей** - реализация login/register
3. **Валидация входных данных** - Joi или Zod
4. **API документация** - Swagger/OpenAPI
5. **Мониторинг в реальном времени** - WebSocket для метрик
6. **Rate limiting** - защита от DoS
7. **Backup базы данных** - автоматическое резервирование
8. **Health checks** - проверка всех систем
9. **Docker контейнеры** - упрощение деплоя
10. **CI/CD пайплайны** - автоматизация тестов и деплоя

## Требования к окружению

- Node.js 18+
- TypeScript 5+
- SQLite 3.44+
- 512MB RAM (минимум)
- 100MB дисковое пространство

## Лицензия

MIT License - свободное использование и модификация
