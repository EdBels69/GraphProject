const fs = require('fs');
const path = require('path');

const prismaDir = path.join(__dirname, '../src/core/prisma');

function processFile(filePath) {
    let content = fs.readFileSync(filePath, 'utf8');

    let modified = false;

    // Remove ESM Shim (only in client.ts usually, but safe to run everywhere if targeted)
    // Match the specific lines generated by Prisma
    if (content.includes("globalThis['__dirname'] = path.dirname(fileURLToPath(import.meta.url))")) {
        content = content.replace("globalThis['__dirname'] = path.dirname(fileURLToPath(import.meta.url))", "// SHIM REMOVED");
        modified = true;
    }
    if (content.includes("import { fileURLToPath } from 'node:url'")) {
        content = content.replace("import { fileURLToPath } from 'node:url'", "// import url removed");
        modified = true;
    }

    // Note: 'node:path' might be used for other things, but in client.ts it's near the shim.
    // We should be careful. Prisma client usually only uses it for the shim.
    // But let's check if it disrupts anything else. The shim is the main issue.

    // Remove .ts extensions from imports/exports
    // Regex for 'from "./something.ts"' or 'from "@/..."'
    // Only target relative imports ending in .ts within quotes
    const importExportRegex = /(from\s+['"])(.+?)(\.ts)(['"])/g;
    if (importExportRegex.test(content)) {
        content = content.replace(importExportRegex, '$1$2$4');
        modified = true;
    }

    if (modified) {
        fs.writeFileSync(filePath, content, 'utf8');
        console.log(`Patched ${filePath}`);
    }
}

function walk(dir) {
    const files = fs.readdirSync(dir);
    for (const file of files) {
        const fullPath = path.join(dir, file);
        if (fs.statSync(fullPath).isDirectory()) {
            walk(fullPath);
        } else if (file.endsWith('.ts')) {
            processFile(fullPath);
        }
    }
}

if (fs.existsSync(prismaDir)) {
    console.log(`Patching Prisma Client in ${prismaDir}...`);
    walk(prismaDir);
    console.log('Patching complete.');
} else {
    console.error(`Prisma dir not found: ${prismaDir}`);
    process.exit(1);
}
